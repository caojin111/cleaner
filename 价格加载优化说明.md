# 价格加载优化说明

## 问题分析
用户反馈Paywall显示"价格加载中"，说明StoreKit产品信息获取的时机太晚，导致用户体验不佳。

## 优化方案

### 1. 应用启动时预加载
- **位置**: `CleanUpAiApp.swift`
- **时机**: 应用启动时立即开始加载
- **方法**: 调用 `StoreKitManager.shared.preloadProducts()`

### 2. 优化加载状态管理
- **改进**: 只在产品列表为空时显示加载状态
- **逻辑**: `storeManager.isLoading && storeManager.products.isEmpty`
- **效果**: 避免重复显示加载状态

### 3. 智能价格回退机制
- **策略**: 如果产品加载失败，显示默认价格
- **默认价格**:
  - 年订阅: $29.99
  - 月订阅: $9.99
  - 周订阅: $2.99

### 4. 实时UI更新
- **监听**: 监听产品列表和加载状态变化
- **刷新**: 自动刷新UI显示最新价格
- **方法**: 使用 `onChange` 和 `objectWillChange.send()`

## 优化后的流程

### 应用启动阶段
1. 应用启动时立即开始预加载产品信息
2. 在后台异步加载，不阻塞UI
3. 记录详细的加载日志

### Paywall显示阶段
1. 如果产品已加载完成，直接显示真实价格
2. 如果正在加载，显示默认价格（避免"加载中"）
3. 加载完成后自动更新为真实价格

### 错误处理
1. 网络错误时显示默认价格
2. 产品不存在时显示默认价格
3. 保持应用可用性

## 性能优化

### 缓存机制
- 产品信息加载后缓存在内存中
- 避免重复网络请求
- 快速响应价格查询

### 异步加载
- 不阻塞主线程
- 不延迟UI显示
- 后台静默更新

### 状态管理
- 精确的加载状态控制
- 避免不必要的UI刷新
- 优化用户体验

## 调试信息

### 日志输出
- 预加载开始时间
- 产品加载状态
- 价格获取结果
- 错误信息详情

### 监控指标
- 加载完成时间
- 成功率统计
- 用户等待时间

## 预期效果

1. **更快的价格显示**: 应用启动时就开始加载
2. **更好的用户体验**: 避免长时间显示"加载中"
3. **更高的可靠性**: 智能回退到默认价格
4. **更流畅的交互**: 实时价格更新

## 测试建议

1. **冷启动测试**: 检查应用启动时的加载时机
2. **网络延迟测试**: 模拟慢网络环境
3. **错误场景测试**: 模拟网络错误和产品不存在
4. **用户体验测试**: 验证价格显示的流畅性 